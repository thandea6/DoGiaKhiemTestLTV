@page
@using UserManagementApp.FE.Models
@model UserManagementApp.FE.Pages.UserManagment.UpdateUserInfoModel
@{
    ViewData["Title"] = "Cập nhật thông tin người dùng";
}

<div class="container mt-4">
    <div class="row">
  <div class="col-md-8 offset-md-2">
  <div class="card shadow">
 <div class="card-header bg-warning text-dark">
 <h3 class="mb-0">
   <i class="bi bi-pencil-square"></i> Cập nhật thông tin người dùng
  </h3>
   </div>
 <div class="card-body">
   @* Hiển thị thông báo lỗi *@
       @if (!string.IsNullOrEmpty(Model.ErrorMessage))
      {
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
<i class="bi bi-exclamation-triangle-fill"></i> @Model.ErrorMessage
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
   }

  @if (Model.UserData != null)
   {
        <form method="post" id="updateUserForm">
@* Hidden field cho UserId *@
  <input type="hidden" asp-for="UserData.UserId" />

      <div class="mb-3">
     <label class="form-label">
        <i class="bi bi-key"></i> Mã người dùng
 </label>
  <input type="text" class="form-control" value="@Model.UserData.UserId" disabled readonly />
      <div class="form-text">Mã người dùng không thể thay đổi</div>
 </div>

<div class="mb-3">
     <label asp-for="UserData.FullName" class="form-label">
     <i class="bi bi-person"></i> Họ và tên <span class="text-danger">*</span>
      </label>
      <input asp-for="UserData.FullName" class="form-control" placeholder="Nhập họ và tên" required />
     <span asp-validation-for="UserData.FullName" class="text-danger"></span>
    </div>

  <div class="mb-3">
    <label asp-for="UserData.BirthDate" class="form-label">
      <i class="bi bi-calendar"></i> Ngày sinh <span class="text-danger">*</span>
    </label>
   <input asp-for="UserData.BirthDate" type="text" class="form-control" id="birthDateInput"
    value="@Model.UserData.BirthDate.ToString("dd/MM/yyyy")"
          placeholder="dd/MM/yyyy" pattern="\d{2}/\d{2}/\d{4}" required />
     <span asp-validation-for="UserData.BirthDate" class="text-danger"></span>
       <div class="form-text">Định dạng: ngày/tháng/năm (VD: 15/01/1990)</div>
   </div>

  <div class="mb-3">
   <label asp-for="UserData.EmailAddress" class="form-label">
   <i class="bi bi-envelope"></i> Email <span class="text-danger">*</span>
 </label>
 <input asp-for="UserData.EmailAddress" type="email" class="form-control" placeholder="example@email.com" required />
  <span asp-validation-for="UserData.EmailAddress" class="text-danger"></span>
    </div>

 <div class="mb-3">
     <label asp-for="UserData.PhoneNumber" class="form-label">
     <i class="bi bi-telephone"></i> Số điện thoại <span class="text-danger">*</span>
  </label>
  <input asp-for="UserData.PhoneNumber" type="tel" class="form-control" placeholder="0912345678" pattern="[0-9]{10}" required />
      <span asp-validation-for="UserData.PhoneNumber" class="text-danger"></span>
    <div class="form-text">Nhập 10 chữ số</div>
      </div>

     <div class="mb-3">
   <label asp-for="UserData.Address" class="form-label">
        <i class="bi bi-geo-alt"></i> Địa chỉ <span class="text-danger">*</span>
     </label>
     <textarea asp-for="UserData.Address" class="form-control" rows="3" placeholder="Nhập địa chỉ" required></textarea>
       <span asp-validation-for="UserData.Address" class="text-danger"></span>
         </div>

   <div class="d-grid gap-2 d-md-flex justify-content-md-end">
      <a href="/UserManagment/ListAllUser" class="btn btn-secondary">
     <i class="bi bi-x-circle"></i> Hủy
 </a>
  <button type="submit" class="btn btn-warning">
    <i class="bi bi-check-circle"></i> Cập nhật
      </button>
       </div>
     </form>
           }
 else
    {
    <div class="alert alert-warning" role="alert">
  <i class="bi bi-exclamation-triangle"></i> Không tìm thấy thông tin người dùng.
    </div>
 <a href="/UserManagment/ListAllUser" class="btn btn-secondary">
   <i class="bi bi-arrow-left"></i> Quay lại danh sách
   </a>
       }
   </div>
   </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
  <script>
document.addEventListener('DOMContentLoaded', function() {
  const birthDateInput = document.getElementById('birthDateInput');
      const form = document.getElementById('updateUserForm');

   // Format ngày khi user nhập (tự động thêm dấu /)
      birthDateInput.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, ''); // Chỉ giữ số
  
 if (value.length >= 2) {
          value = value.substring(0, 2) + '/' + value.substring(2);
   }
  if (value.length >= 5) {
         value = value.substring(0, 5) + '/' + value.substring(5, 9);
      }
  
       e.target.value = value;
   });

      // Validate và confirm trước khi submit
    form?.addEventListener('submit', function(e) {
        const birthDateValue = birthDateInput.value;
const phoneInput = document.querySelector('input[type="tel"]');
    const phoneValue = phoneInput?.value;

   // Validate định dạng ngày dd/MM/yyyy
     const datePattern = /^(\d{2})\/(\d{2})\/(\d{4})$/;
      const match = birthDateValue.match(datePattern);

   if (!match) {
       e.preventDefault();
      alert('Ngày sinh không đúng định dạng dd/MM/yyyy!');
       birthDateInput.focus();
     return false;
           }

       const day = parseInt(match[1], 10);
 const month = parseInt(match[2], 10);
     const year = parseInt(match[3], 10);

    // Validate ngày và tháng hợp lệ
  if (month < 1 || month > 12 || day < 1 || day > 31) {
        e.preventDefault();
    alert('Ngày hoặc tháng không hợp lệ!');
   birthDateInput.focus();
 return false;
    }

     // Validate ngày tồn tại trong tháng
     const date = new Date(year, month - 1, day);
    if (date.getDate() !== day || date.getMonth() !== month - 1 || date.getFullYear() !== year) {
       e.preventDefault();
          alert('Ngày không tồn tại trong tháng này!');
birthDateInput.focus();
return false;
   }

       // Validate số điện thoại
      if (phoneValue && !/^\d{10}$/.test(phoneValue)) {
  e.preventDefault();
     alert('Số điện thoại phải là 10 chữ số!');
 phoneInput.focus();
          return false;
      }

     // Confirm update
          if (!confirm('Bạn có chắc chắn muốn cập nhật thông tin người dùng này?')) {
    e.preventDefault();
   return false;
    }

   // Convert dd/MM/yyyy sang yyyy-MM-dd cho server
  birthDateInput.value = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
   });
  });
    </script>
}
